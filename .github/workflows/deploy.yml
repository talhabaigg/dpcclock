name: deploy

on:
  push:
    branches:
      - main

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  test:
    uses: ./.github/workflows/tests.yml

  deploy:
    runs-on: ubuntu-latest
    needs: [lint, test]
    environment: production

    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            cd ${{ secrets.APP_PATH }}

            # ---- PHASE 1: Slow steps (site stays live) ----

            # Pull latest code
            git stash --include-untracked || true
            git pull origin main
            git stash drop || true

            # Fix permissions (files may be owned by www-data)
            sudo chown -R $(whoami) vendor/ public/build/ storage/ || true

            # Install PHP dependencies
            composer install --no-dev --no-interaction --optimize-autoloader

            # Install and build frontend assets
            npm ci --legacy-peer-deps
            npm run build

            # ---- PHASE 2: Fast steps only (brief downtime) ----

            # Enable maintenance mode
            php artisan down --secret="${{ secrets.MAINTENANCE_SECRET }}"

            # Run migrations
            php artisan migrate --force

            # Seed roles and permissions
            php artisan db:seed --class=RolesAndPermissionsSeeder --force

            # Clear and warm caches
            php artisan optimize

            # Restart queue workers to pick up new code
            php artisan queue:restart
            sudo supervisorctl restart all

            # Reload PHP-FPM to pick up new code
            sudo systemctl reload php8.4-fpm

            # Disable maintenance mode
            php artisan up

            echo "Deployment complete!"
